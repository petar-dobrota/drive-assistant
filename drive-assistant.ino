#include <Arduino.h>
#include <Wire.h>
#include <OBD.h>
#include "Int64.h"
#include "Timer.h"

#include "pins.h"
#include "InputData.h"

#include "RpmToThrottleFunction.h"
#include "RevMatcher.h"
#include "OverrevNotifier.h"

// obd adapter pinout:
// rx - white
// tx - green

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CONSTANTS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

const float GEAR_RATIOS[5] = {98.4252f, 59.5613f, 40.1856f, 30.6805f, 23.5658f}; // gearRatio=rpm/v

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// GLOBALS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 
Timer time;
InputData input;
RpmToThrottleFunction rpmToThrottle;
EngineControl engine(&input, &rpmToThrottle);
RevMatcher revMatcher(&engine);
OverrevNotifier overrevNotifier;

void beep() {

  bool on = true;
  
  for (int i = 0; i < 250; i++) {

    on = ((i % 3) != 0);
    digitalWrite(OVERREV_ALARM_PIN, !on);
    delayMicroseconds(1000);
  }
  digitalWrite(OVERREV_ALARM_PIN, HIGH);
  
}


void setup()
{
  pinMode(OVERREV_ALARM_PIN, OUTPUT);
  digitalWrite(OVERREV_ALARM_PIN, HIGH);
  
  pinMode(CLUTCH_DOWN_PIN, INPUT);
  pinMode(CLUTCH_PLAY_PIN, INPUT);
  
  pinMode(TEST_PIN, OUTPUT);
  pinMode(TEST_IN, INPUT);
  
  digitalWrite(TEST_PIN, HIGH);

  input.begin();
  Wire.begin();

  beep();
  delay(200);
  beep();
  delay(200);
  beep();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// LOOP
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void loop()
{

  input.collect();
    
  overrevNotifier.highRevNotifying(&input);

  if (revMatcher.revMatching(&input)) {
    return;
  }

  // TODO: cruiseControling, launchControling
  
}
