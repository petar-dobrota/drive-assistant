#include <Arduino.h>
#include <Wire.h>
#include <OBD.h>

// obd adapter pinout:
// rx - white
// tx - green

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CONSTANTS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// PINS
const unsigned ALARM_PIN = 13;
const unsigned ALARM_SPEAKER_PIN = 10;
const unsigned CLUTCH_DOWN_PIN = 9;
const unsigned CLUTCH_TOUCH_PIN = 8;

// SETTINGS
const int REV_LIMIT = 2500; // TODO: change to 6000
const unsigned ALARM_T_MICROS = 1000000 / 1500;
const unsigned NUM_GEARS = 5;
const float GEAR_RATIOS[NUM_GEARS] = {98.4252f, 59.5613f, 40.1856f, 30.6805f, 23.5658f}; // gearRatio=rpm/v
const float GEAR_RATIO_TOLERANCE = 0.15f; // gear ratio tolerance when determinating in which gear car is 

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// GLOBALS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

COBD obd;
int currRpm;
int currSpeed;

void setup()
{

  pinMode(ALARM_PIN, OUTPUT);
  pinMode(ALARM_SPEAKER_PIN, OUTPUT);

  pinMode(CLUTCH_DOWN_PIN, INPUT);
  pinMode(CLUTCH_TOUCH_PIN, INPUT);
  

  obd.begin();
  while (!obd.init());  
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// General functions
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int obdRead(byte pid) {
  int value;
  if (obd.read(pid, value)) {
    return pid;
  } else {
    // TODO: Stop exec
    return -1;
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Sub coroutines: Called from main coroutines. Routines are doing it's thing while being called.
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void alarmRinging() {
  static unsigned long lastTick = 0;

  unsigned long now = micros();

  if (lastTick > now) {
    // timer overflow, hack for this periode
    lastTick = now;
  }

  if (lastTick + ALARM_T_MICROS <= now) {
    // whole periode passed
    digitalWrite(ALARM_SPEAKER_PIN, !digitalRead(ALARM_SPEAKER_PIN));
    lastTick = now;
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN CORUTINES: 
// Will be called from main loop.
// Return true if no other co-routines should be called per a this loop
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int lastGear;
bool gearMonitoring() {
  if (digitalRead(CLUTCH_TOUCH_PIN)) {
    // can't calc gear if clutch is engaged
    return false;
  }

  float currRatio = (float)currRpm / currSpeed;
  int gear = -1;
  for (int i = 0; i < NUM_GEARS; i++) {
    float maxDelta = GEAR_RATIOS[i] * GEAR_RATIO_TOLERANCE;
    if ((currRatio > GEAR_RATIOS[i] - maxDelta) && (currRatio < GEAR_RATIOS[i] + maxDelta)) {
      gear = i + 1;
      break;
    }
  }
  if (gear != -1) {
    lastGear = gear;
  }
  
  return false;
}

bool highRevNotifying() {

  if (currRpm > REV_LIMIT) {
     digitalWrite(ALARM_PIN, HIGH);
     alarmRinging();
  } else {
    // alarm off
    digitalWrite(ALARM_PIN, LOW);
    digitalWrite(ALARM_SPEAKER_PIN, LOW);
  }

  // high revs notify doesn't interfere with other co-routines
  return false;
}

bool revMatching() {
  // TODO:
  
  return false;
}

bool cruiseControling() {
  // TODO:
  
  return false;
}

bool launchControling() {
  // TODO:
  
  return false;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// LOOP
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void loop()
{

  // TODO: OBD READS
  currRpm = obdRead(PID_RPM);
  currSpeed = obdRead(PID_SPEED);
  
  if (gearMonitoring()) {
    return;
  }
  
  if (highRevNotifying()) {
    return;
  }

  if (revMatching()) {
    return;
  }

  if (cruiseControling()) {
    return;
  }

  if (launchControling()) {
    return;
  }
  
}
